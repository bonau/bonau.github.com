---
layout: post
title: (HABTM) has_and_belongs_to_many Bug in Ruby On Rails
categories:
- 不斷開發
tags: []
published: true
comments: true
---
<p>Once the HABTM relation was made, for example:
<pre><code>class Song &lt; ActiveRecord::Base
  has_and_belongs_to_many :artists
end
</code></pre>
The operation shown below is valid:
<pre><code>song.artists &lt;&lt; Artist.new(:name =&gt; 'Barbra Streisand')
</code></pre>
But this may make a BIG problem:
<pre><code>song.artists &lt;&lt; Artist.find(:name =&gt; 'Barbra Streisand')</code></pre></p>

<p>Mysql::Error: Duplicate entry '1' for key 1: INSERT INTO artists_songs (`artist_id`, `id`, `song_id`) VALUES (1, 1, 3)

The <code>id</code> field should be "autoincrement". Why pass a Fixnum to it? That is the question. I find out that when we push(&lt;&lt;) an artist to a song, whole the attributes on this artist will  be expanded as arguments of the SQL query. And then duplicate :id to :artist_id.</p>

<p>Hum, it sounds great. There is no problem. <em>But</em> the :id key-value pair is still. That means <strong>we will establish a HABTM relation with a given key</strong>. So we sometimes get error from here. Try the tricky way:
<pre><code>class Song &lt; ActiveRecord::Base
  has_and_belongs_to_many :artists,
  :insert_sql =&gt; 'INSERT INTO `artists_songs` ( `song_id`, `artist_id` )
                  VALUES (#{id}, #{record.id})'
end
</code></pre>
How awful the code!</p>
